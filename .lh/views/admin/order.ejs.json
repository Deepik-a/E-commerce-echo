{
    "sourceFile": "views/admin/order.ejs",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1736826280759,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1736826292529,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -328,9 +328,8 @@\n         'Confirmed': 'bg-green-100 text-green-800',\r\n         'Shipped': 'bg-blue-100 text-blue-800',\r\n         'Delivered': 'bg-purple-100 text-purple-800',\r\n         'Cancelled': 'bg-red-100 text-red-800',\r\n-        \r\n     };\r\n     return statusClasses[status] || 'bg-gray-100 text-gray-800';\r\n }\r\n \r\n"
                },
                {
                    "date": 1736826304989,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -58,9 +58,9 @@\n                                         <span><%=item.productId.name%> hlooo deepika</span>\r\n                                     </div>\r\n                                     \r\n                                     <!-- Status change buttons with irreversibility check -->\r\n-                                    <% const statusOptions = ['Pending', 'Shipped', 'Delivered', 'Returned']; %>\r\n+                                    <% const statusOptions = ['Pending', 'Shipped', 'Delivered']; %>\r\n                                     <% const currentStatusIndex = statusOptions.indexOf(item.status); %>\r\n                                     \r\n                                     <% statusOptions.forEach((status, index) => { %>\r\n                                         <% if (item.status !== 'Cancelled' && item.status !== 'Requested' && item.status !== 'Rejected') { %> <!-- Add this check -->\r\n@@ -328,8 +328,9 @@\n         'Confirmed': 'bg-green-100 text-green-800',\r\n         'Shipped': 'bg-blue-100 text-blue-800',\r\n         'Delivered': 'bg-purple-100 text-purple-800',\r\n         'Cancelled': 'bg-red-100 text-red-800',\r\n+        'Returned': 'bg-gray-100 text-gray-800'\r\n     };\r\n     return statusClasses[status] || 'bg-gray-100 text-gray-800';\r\n }\r\n \r\n"
                }
            ],
            "date": 1736826280759,
            "name": "Commit-0",
            "content": "\r\n<%- include('sidebar') %>\r\n<!-- Tailwind CSS CDN -->\r\n<link href=\"https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css\" rel=\"stylesheet\">\r\n\r\n<div class=\"max-w mx-auto p-6 ml-64\">\r\n    <div class=\"bg-white rounded-lg shadow\">\r\n        <!-- Header -->\r\n        <div class=\"px-6 py-4 border-b border-gray-200 ml-64\">\r\n            <div class=\"flex items-center justify-between\">\r\n                <h1 class=\"text-3xl font-semibold text-gray-800\">Order Management</h1>\r\n                <span class=\"px-3 py-1 text-lg bg-gray-100 text-gray-700 rounded-full\">\r\n                    Total Orders: <%= orders.length %>\r\n                </span>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- Table -->\r\n        <div class=\"overflow-x-auto\">\r\n            <table class=\"w-full ml-64\">\r\n                <thead>\r\n                    <tr class=\"bg-gray-50\">\r\n                        <th class=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                            Order ID\r\n                        </th>\r\n                        <th class=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                            Customer\r\n                        </th>\r\n                        <th class=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                            Items\r\n                        </th>\r\n                        <th class=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                            Status\r\n                        </th>\r\n                        <th class=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                           Details\r\n                        </th>\r\n                        <th class=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                            Actions\r\n                         </th>\r\n                    </tr>\r\n                </thead>\r\n                <tbody class=\"divide-y divide-gray-200\">\r\n                    <% orders.forEach(order => { %>\r\n                        <tr class=\"hover:bg-gray-50\">\r\n                            <td class=\"px-6 py-4 whitespace-nowrap text-lg font-medium text-gray-900\">\r\n                                <%= order._id %>\r\n                            </td>\r\n                            <td class=\"px-6 py-4 whitespace-nowrap text-lg text-gray-500\">\r\n                                <%= order.userId.name %>\r\n                            </td>\r\n                            <td class=\"px-6 py-4 text-lg text-gray-500\">\r\n                                <% order.items.forEach(item => { %>\r\n                                    <div class=\"flex items-center space-x-2\">\r\n                                        <span class=\"w-4 h-4 bg-blue-100 rounded-full flex items-center justify-center text-xs text-blue-600\">\r\n                                            <%= item.productCount %>\r\n                                        </span>\r\n                                        <span><%=item.productId.name%> hlooo deepika</span>\r\n                                    </div>\r\n                                    \r\n                                    <!-- Status change buttons with irreversibility check -->\r\n                                    <% const statusOptions = ['Pending', 'Shipped', 'Delivered', 'Returned']; %>\r\n                                    <% const currentStatusIndex = statusOptions.indexOf(item.status); %>\r\n                                    \r\n                                    <% statusOptions.forEach((status, index) => { %>\r\n                                        <% if (item.status !== 'Cancelled' && item.status !== 'Requested' && item.status !== 'Rejected') { %> <!-- Add this check -->\r\n                                            <button \r\n                                                onclick=\"updateStatus('<%= order._id %>', '<%= item.productId._id %>', '<%= status %>')\"\r\n                                                class=\"px-3 py-1 text-xs rounded-md <%= status === item.status ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-800 hover:bg-gray-200' %>\"\r\n                                                <%= index <= currentStatusIndex ? 'hidden' : '' %>>\r\n                                                <%= status %>\r\n                                            </button>\r\n                                        <% } %>\r\n                                    <% }) %>\r\n                                    \r\n                                <% }) %>\r\n                            </td>\r\n                            <td class=\"px-6 py-4 whitespace-nowrap\">\r\n                                <% order.items.forEach(item => { %>\r\n                                    <% const statusColors = {\r\n                                        'Pending': 'bg-yellow-100 text-yellow-800',\r\n                                        'Shipped': 'bg-blue-100 text-blue-800',\r\n                                        'Confirmed': 'bg-green-100 text-green-800',\r\n                                        'Delivered': 'bg-purple-100 text-purple-800',\r\n                                        'Cancelled': 'bg-red-100 text-red-800',\r\n                                        'Returned': 'bg-gray-100 text-gray-800',\r\n                                        'Requested': 'bg-violet-100 text-violet-800'\r\n                                    } %>\r\n                                    <span class=\"px-3 py-1 text-xs rounded-full <%= statusColors[item.status] %>\">\r\n                                        <%= item.status %>\r\n                                    </span>\r\n                                <% }) %>\r\n                            </td>\r\n                            <td class=\"px-4 py-4 flex space-x-2\">\r\n                                <button onclick=\"viewOrder('<%= order._id %>')\" \r\n                                    class=\"inline-flex items-center px-3 py-2 border border-transparent text-lg leading-4 font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500\">\r\n                                    View\r\n                                </button>\r\n                            </td>\r\n                            <td class=\"px-6 py-4 whitespace-nowrap text-lg text-gray-500\">\r\n    <% order.items.forEach(item => { %>\r\n        <% if (item.status === 'Requested') { %>\r\n            <a href=\"/admin/viewReason/<%=order._id%>/<%=item.productId._id%>\"><button \r\n                class=\"px-4 py-2 text-lg font-medium text-white bg-blue-600 rounded-md hover:bg-blue-500\">\r\n                View Return Reason\r\n            </button></a>\r\n        <% } %>\r\n    <% }) %>\r\n</td>\r\n\r\n\r\n                 \r\n                        </tr>\r\n                        \r\n                    <% }) %>\r\n                </tbody> \r\n            </table>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n\r\n<div class=\"mt-4 flex justify-center space-x-4\">\r\n    <% if (currentPage > 1) { %>\r\n      <a href=\"?page=<%= currentPage - 1 %>&limit=10\" class=\"bg-gray-200 text-black px-4 py-2 rounded hover:bg-gray-300\">Previous</a>\r\n    <% } %>\r\n    \r\n    <% for (let i = 1; i <= totalPages; i++) { %>\r\n      <a href=\"?page=<%= i %>&limit=10\" class=\"bg-gray-200 text-black px-4 py-2 rounded hover:bg-gray-300 <%= currentPage === i ? 'bg-gray-400' : '' %>\">\r\n        <%= i %>\r\n      </a>\r\n    <% } %>\r\n    \r\n    <% if (currentPage < totalPages) { %>\r\n      <a href=\"?page=<%= currentPage + 1 %>&limit=10\" class=\"bg-gray-200 text-black px-4 py-2 rounded hover:bg-gray-300\">Next</a>\r\n    <% } %>\r\n  </div>\r\n\r\n\r\n<!-- Modal -->\r\n\r\n<div id=\"modalBackground\" class=\"fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity z-40 hidden\"></div>\r\n<div id=\"orderModal\" class=\"fixed inset-0 z-50 flex items-center justify-center p-4 hidden\">\r\n    <div class=\"relative w-full max-w-4xl bg-white rounded-xl shadow-2xl\">\r\n        <!-- Header -->\r\n        <h2 class=\"text-2xl font-semibold text-gray-900 p-6 border-b border-gray-200\">Order Details</h2>\r\n\r\n        <!-- Main Content -->\r\n        <div class=\"p-6\">\r\n            <!-- Two Column Grid -->\r\n            <div class=\"grid grid-cols-1 md:grid-cols-2 gap-6 mb-8\">\r\n                <!-- Left Column -->\r\n                <div>\r\n                    <div class=\"mb-4\">\r\n                        <p class=\"font-medium text-gray-900\">Order ID: <span id=\"orderId\" class=\"text-gray-700\"></span></p>\r\n                        <p class=\"font-medium text-gray-900\">Order Date: <span id=\"orderDate\" class=\"text-gray-700\"></span></p>\r\n                    </div>\r\n\r\n                    <div class=\"mt-6\">\r\n                        <h3 class=\"text-lg font-semibold text-gray-900 mb-2\">Shipping Address</h3>\r\n                        <p id=\"shippingAddress\" class=\"text-gray-700\"></p>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Right Column -->\r\n                <div>\r\n                    <div class=\"mb-4\">\r\n                        <h3 class=\"text-lg font-semibold text-gray-900 mb-2\">Payment Method</h3>\r\n                        <p id=\"paymentMethod\" class=\"text-gray-700\"></p>\r\n                    </div>\r\n                    <div class=\"mb-4\">\r\n                        <h3 class=\"text-lg font-semibold text-gray-900 mb-2\">Coupon Discount</h3>\r\n                        <p id=\"couponApplied\" class=\"text-gray-700\"></p>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <!-- Items Table -->\r\n            <div class=\"mt-8\">\r\n                <h3 class=\"text-lg font-semibold text-gray-900 mb-4\">Items Purchased</h3>\r\n                <div class=\"overflow-x-auto\">\r\n                    <table class=\"w-full\">\r\n                        <thead>\r\n                            <tr class=\"bg-gray-50\">\r\n                                <th class=\"px-6 py-3 text-left text-lg font-medium text-gray-700\">Product</th>\r\n                                <th class=\"px-6 py-3 text-left text-lg font-medium text-gray-700\">Image</th>\r\n                                <th class=\"px-6 py-3 text-left text-lg font-medium text-gray-700\">Quantity</th>\r\n                                <th class=\"px-6 py-3 text-left text-lg font-medium text-gray-700\">Price</th>\r\n                                <th class=\"px-6 py-3 text-left text-lg font-medium text-gray-700\">Discount</th>\r\n                                <th class=\"px-6 py-3 text-left text-lg font-medium text-gray-700\">Status</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody id=\"itemsPurchased\" class=\"divide-y divide-gray-200\">\r\n                            <!-- Items will be dynamically inserted here -->\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n            </div>\r\n\r\n            <!-- Footer -->\r\n            <div class=\"mt-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4\">\r\n                <!-- Total Price -->\r\n                <p class=\"text-lg md:mb-0\">\r\n                    <span class=\"font-semibold text-gray-900\">Total Price:</span>\r\n                    <span class=\"ml-2\">&#8377;<span id=\"totalPrice\" class=\"text-gray-900\"></span></span>\r\n                </p>\r\n\r\n                <!-- Close Button -->\r\n                <button onclick=\"closeModal()\" class=\"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors duration-200\">\r\n                    Close\r\n                </button>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n\r\n\r\n\r\n\r\n<script>\r\n\r\n    function showReasonModal (orderId,productId,reason){\r\n        console.log('hai')\r\n        console.log(`orderId = ${orderId}`)\r\n        console.log(`productID = ${productId}`);\r\n        console.log(`reason = ${reason}`)\r\n    }\r\n    function viewOrder(orderId) {\r\n    // Show modal\r\n    document.getElementById('modalBackground').classList.remove('hidden');  \r\n    document.getElementById('orderModal').classList.remove('hidden');\r\n\r\n    // Fetch order details\r\n    fetch(`/admin/orders/${orderId}`)\r\n        .then(response => response.json())\r\n        .then(order => {\r\n            // Populate basic order details\r\n            document.getElementById('orderId').textContent = order.orderId || order._id;\r\n            document.getElementById('orderDate').textContent = new Date(order.createdAt).toLocaleDateString();\r\n            document.getElementById('shippingAddress').textContent =  order.address;\r\n   \r\n\r\n            document.getElementById('couponApplied').textContent = order.couponDiscount;\r\n            document.getElementById('paymentMethod').textContent = order.paymentMethod;\r\n            document.getElementById('totalPrice').textContent = order.payableAmount.toLocaleString();\r\n\r\n            // Clear existing items\r\n            const itemsTable = document.getElementById('itemsPurchased');\r\n            itemsTable.innerHTML = '';\r\n\r\n\r\n   \r\n            // Add items with status\r\n            order.items.forEach(item => {\r\n                console.log(`Processing item at index:`, item); \r\n                const row = document.createElement('tr');\r\n                row.innerHTML = `\r\n            <tr class=\"hover:bg-gray-50 transition-colors\">\r\n    <!-- Product Name -->\r\n    <td class=\"px-6 py-4\">\r\n        <p class=\"text-lg text-gray-700 font-medium\">${item.productId.name}</p>\r\n    </td>\r\n    \r\n    <!-- Product Image -->\r\n<td class=\"px-6 py-4\">\r\n  <img src=\"/uploads/${item.productImage}\" \r\n       alt=\"Product image\" \r\n       class=\"w-16 h-16 object-cover rounded-lg shadow-sm hover:shadow-md transition-shadow\">\r\n</td>\r\n\r\n    <!-- Product Count -->\r\n    <td class=\"px-6 py-4\">\r\n        <span class=\"text-lg text-gray-700\">${item.productCount}</span>\r\n    </td>\r\n    \r\n    <!-- Product Price -->\r\n    <td class=\"px-6 py-4\">\r\n        <span class=\"text-lg font-medium text-gray-900\">\r\n            ₹${item.productPrice} × ${item.productCount}\r\n        </span>\r\n    </td>\r\n    \r\n    <!-- Discount -->\r\n    <td class=\"px-6 py-4\">\r\n        <span class=\"text-lg font-medium text-green-600\">\r\n            ${item.productId.discount}%\r\n        </span>\r\n    </td>\r\n    \r\n    <!-- Status -->\r\n    <td class=\"px-6 py-4\">\r\n        <div class=\"flex flex-col gap-2\">\r\n            <span class=\"px-3 py-1 text-xs font-medium rounded-full inline-flex items-center justify-center ${getStatusClass(item.status)}\">\r\n                ${item.status}\r\n            </span>\r\n            <span class=\"text-xs text-gray-500\">\r\n                ${getStatusTimeline(item.status)}\r\n            </span>\r\n        </div>\r\n    </td>\r\n</tr>\r\n            \r\n                `;\r\n                itemsTable.appendChild(row);\r\n            });\r\n\r\n            // Add order status section\r\n            const orderStatusDiv = document.getElementById('orderStatus');\r\n            if (orderStatusDiv) {\r\n                orderStatusDiv.innerHTML = `\r\n                    <div class=\"flex items-center space-x-2\">\r\n                        <span class=\"px-3 py-1 text-xs font-medium rounded-full ${getStatusClass(order.status)}\">\r\n                            ${order.status}\r\n                        </span>\r\n                        ${order.isCancel ? \r\n                            '<span class=\"text-red-600 text-lg\">(Order Cancelled)</span>' \r\n                            : ''}\r\n                    </div>\r\n                `;\r\n            }\r\n        });\r\n}\r\n\r\nfunction getStatusClass(status) {\r\n    const statusClasses = {\r\n        'Pending': 'bg-yellow-100 text-yellow-800',\r\n        'Confirmed': 'bg-green-100 text-green-800',\r\n        'Shipped': 'bg-blue-100 text-blue-800',\r\n        'Delivered': 'bg-purple-100 text-purple-800',\r\n        'Cancelled': 'bg-red-100 text-red-800',\r\n        \r\n    };\r\n    return statusClasses[status] || 'bg-gray-100 text-gray-800';\r\n}\r\n\r\nfunction getStatusTimeline(currentStatus) {\r\n    const statuses = ['Pending', 'Confirmed', 'Shipped', 'Delivered'];\r\n    const currentIndex = statuses.indexOf(currentStatus);\r\n    \r\n    if (currentStatus === 'Cancelled' || currentStatus === 'Returned') {\r\n        return ''; // Don't show timeline for cancelled/returned items\r\n    }\r\n\r\n    return `\r\n        <div class=\"mt-2\">\r\n            <div class=\"flex items-center space-x-2 text-xs\">\r\n                ${statuses.map((status, index) => `\r\n                    <span class=\"${index <= currentIndex ? 'text-blue-600' : 'text-gray-400'}\">\r\n                        ${status}\r\n                    </span>\r\n                    ${index < statuses.length - 1 ? `\r\n                        <span class=\"${index < currentIndex ? 'text-blue-600' : 'text-gray-300'}\">→</span>\r\n                    ` : ''}\r\n                `).join('')}\r\n            </div>\r\n        </div>\r\n    `;\r\n}\r\n\r\nfunction closeModal() {\r\n    document.getElementById('modalBackground').classList.add('hidden');\r\n    document.getElementById('orderModal').classList.add('hidden');\r\n}\r\n\r\n\r\nfunction updateStatus(orderId, productId, newStatus) {\r\n        Swal.fire({\r\n            title: 'Change Status?',\r\n            text: `Are you sure you want to change the status to \"${newStatus}\"? Once changed, it cannot be reverted.`,\r\n            icon: 'warning',\r\n            showCancelButton: true,\r\n            confirmButtonColor: '#3085d6',\r\n            cancelButtonColor: '#d33',\r\n            confirmButtonText: 'Yes, change it!'\r\n        }).then((result) => {\r\n            if (result.isConfirmed) {\r\n                // Send the status update via fetch (AJAX) to avoid page reload\r\n                fetch('/admin/orders/status', {\r\n                    method: 'POST',\r\n                    headers: {\r\n                        'Content-Type': 'application/json'\r\n                    },\r\n                    body: JSON.stringify({ orderId: orderId, productId: productId, status: newStatus })\r\n                })\r\n                .then(response => response.json())\r\n                .then(data => {\r\n                    if (data.success) {\r\n                        Swal.fire(\r\n                            'Updated!',\r\n                            'The order status has been updated and cannot be changed back.',\r\n                            'success'\r\n                        ).then(() => {\r\n                            // Reload or update the page to reflect the new status\r\n                            location.reload();\r\n                        });\r\n                    } else {\r\n                        Swal.fire('Error', 'There was an issue updating the status.', 'error');\r\n                    }\r\n                })\r\n                .catch(error => {\r\n                    Swal.fire('Error', 'Failed to update status.', 'error');\r\n                });\r\n            }\r\n        });\r\n    }\r\n    \r\n\r\n\r\n\r\n\r\n\r\n    </script>\r\n    <style>\r\n        /* Modal background */\r\n#modalBackground {\r\n    background-color: rgba(0, 0, 0, 0.5); /* Darken background */\r\n}\r\n\r\n/* Modal box */\r\n#orderModal {\r\n    max-width: 80%; /* Adjust width */\r\n    padding: 20px;\r\n    border-radius: 8px;\r\n}\r\n\r\n/* Close button */\r\nbutton {\r\n    transition: background-color 0.3s ease;\r\n}\r\n\r\nbutton:hover {\r\n    background-color: #2563EB; /* Darker blue on hover */\r\n}\r\n   \r\n   </style>\r\n  "
        }
    ]
}