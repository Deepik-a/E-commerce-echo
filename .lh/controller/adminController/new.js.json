{
    "sourceFile": "controller/adminController/new.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1736681324094,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1736681324094,
            "name": "Commit-0",
            "content": "<%- include('../layouts/header.ejs') %>\r\n<div class=\"flex ml-64\">\r\n  <%- include('../layouts/sidebar.ejs') %>\r\n  \r\n  <div class=\"container mx-auto px-4 py-8 flex-1\">\r\n    <div class=\"mb-6\">\r\n      <div class=\"flex justify-between items-center mb-6\">\r\n        <h1 class=\"text-2xl font-semibold text-gray-800\">Sales Report</h1>\r\n        \r\n        <div class=\"flex gap-4\">\r\n          <!-- Filter Dropdown -->\r\n          <div class=\"relative\">\r\n            <select id=\"filterOption\" class=\"bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500\">\r\n              <option value=\"\">Filter</option>\r\n              <option value=\"day\">This Day</option>\r\n              <option value=\"week\">This Week</option>\r\n              <option value=\"month\">This Month</option>\r\n              <option value=\"year\">This Year</option>\r\n            </select>\r\n          </div>\r\n          \r\n          <!-- Export Dropdown -->\r\n          <div class=\"relative\">\r\n            <select id=\"export\" class=\"bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500\">\r\n              <option value=\"\">Export Report</option>\r\n              <option value=\"excel\">Excel Sheet</option>\r\n              <option value=\"pdf\">PDF</option>\r\n            </select>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <div class=\"bg-white h-28 flex justify-between items-center my-6 px-4 py-5 shadow-lg rounded-lg space-x-6\">\r\n      <div class=\"flex-1 px-5 py-3 bg-gray-100 rounded-md flex flex-col justify-center items-center text-gray-700 font-medium shadow-sm hover:bg-gray-200 transition duration-300 ease-in-out\">\r\n        <span class=\"text-xs uppercase tracking-wider text-gray-500\">Overall Sales Count</span>\r\n        <span id=\"overallSalesCount\" class=\"text-2xl font-semibold mt-1\"><%= overallSalesCount %></span>\r\n      </div>\r\n      <div class=\"flex-1 px-5 py-3 bg-gray-100 rounded-md flex flex-col justify-center items-center text-gray-700 font-medium shadow-sm hover:bg-gray-200 transition duration-300 ease-in-out\">\r\n        <span class=\"text-xs uppercase tracking-wider text-gray-500\">Overall Order Amount</span>\r\n        <span id=\"overallOrderAmount\" class=\"text-2xl font-semibold mt-1\">₹ <%= overallOrderAmount.toFixed(2) %></span>\r\n      </div>\r\n      <div class=\"flex-1 px-5 py-3 bg-gray-100 rounded-md flex flex-col justify-center items-center text-gray-700 font-medium shadow-sm hover:bg-gray-200 transition duration-300 ease-in-out\">\r\n        <span class=\"text-xs uppercase tracking-wider text-gray-500\">Overall Coupon Discount</span>\r\n        <span id=\"totalCouponDiscount\" class=\"text-2xl font-semibold mt-1\">₹ <%= totalCouponDiscount.toFixed(2) %></span>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- Sales Report Table -->\r\n    <div class=\"bg-white rounded-lg shadow-md overflow-x-auto\">\r\n      <table class=\"min-w-full divide-y divide-gray-200\">\r\n        <thead class=\"bg-gray-50\">\r\n          <tr>\r\n            <th scope=\"col\" class=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Order ID</th>\r\n            <th scope=\"col\" class=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">User ID</th>\r\n            <th scope=\"col\" class=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Order Date</th>\r\n            <th scope=\"col\" class=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Order Amount</th>\r\n            <th scope=\"col\" class=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Coupon Deduction</th>\r\n            <th scope=\"col\" class=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Payment Status</th>\r\n            <th scope=\"col\" class=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Payment Method</th>\r\n          </tr>\r\n        </thead>\r\n        <tbody class=\"bg-white divide-y divide-gray-200\">\r\n          <% data.forEach(data =>{ %>\r\n          <tr class=\"hover:bg-gray-50\">\r\n            <td class=\"px-6 py-4 text-sm text-gray-600\"><%= data.orderId %></td>\r\n            <td class=\"px-6 py-4 text-sm text-gray-600\"><%= data.userId.toString().substring(0, 4) + '...' + data.userId.toString().slice(-5) %></td>\r\n            <td class=\"px-6 py-4 text-sm text-gray-600\"><%= new Date(data.createdAt).toLocaleDateString('en-GB') %></td>\r\n            <td class=\"px-6 py-4 text-sm text-gray-600\">₹ <%= data.totalPrice.toFixed(2) %></td>\r\n            <td class=\"px-6 py-4 text-sm text-gray-600\">₹ <%= data.couponDiscount.toFixed(2) %></td>\r\n            <td class=\"px-6 py-4 text-sm\">\r\n              <span class=\"<%= data.orderStatus === 'Paid'%>px-6 py-4 text-sm text-gray-600\">\r\n                <%= data.orderStatus %>\r\n              </span>\r\n            </td>\r\n            <td class=\"px-6 py-4 text-sm text-gray-600\"><%= data.paymentMethod %></td>\r\n   \r\n          </tr>\r\n          <% }) %>\r\n        </tbody>\r\n      </table>\r\n    </div>\r\n\r\n    <!-- Pagination -->\r\n    <div class=\"flex justify-between items-center mt-6\">\r\n      <div class=\"text-sm text-gray-600\">\r\n        Showing <span class=\"font-medium\" id=\"currentPage\"><%= currentPage %></span> to \r\n        <span class=\"font-medium\" id=\"totalPages\"><%= totalPages %></span> of \r\n        <span class=\"font-medium\" id=\"totalRecords\"><%= totalRecordsCount %></span> results\r\n      </div>\r\n      <div class=\"inline-flex gap-2\">\r\n        <button id=\"prevPage\" class=\"px-4 py-2 border border-gray-300 rounded-md text-gray-600 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500\">\r\n          Previous\r\n        </button>\r\n        <button id=\"nextPage\" class=\"px-4 py-2 border border-gray-300 rounded-md text-gray-600 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500\">\r\n          Next\r\n        </button>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</div>\r\n    <script>\r\n     let currentPage = parseInt(document.getElementById('currentPage').innerHTML);\r\n      let totalPages = parseInt(document.getElementById('totalPages').innerHTML);\r\n      let overallSalesCount = document.getElementById('overallSalesCount');\r\n      let overallOrderAmount = document.getElementById('overallOrderAmount');\r\n      let totalCouponDiscount = document.getElementById('totalCouponDiscount');\r\n    \r\n      \r\n      \r\n    \r\n    \r\n      console.log(\"current \", currentPage);\r\n      console.log(\"Total \", totalPages);\r\n      \r\n    \r\n      // Fetch Sales Report\r\n      function fetchSalesReport(page, filterOption = '') {\r\n        console.log(\"page in fetchSalesReport = \",page);\r\n        \r\n        const URL = `/admin/salesReport?page=${page}&filter=${filterOption}`;\r\n    \r\n        fetch(URL, {\r\n          headers: {\r\n            'Accept': 'application/json',\r\n          },\r\n        })\r\n        .then(response => {\r\n          if (!response.ok) {\r\n            throw new Error(`Server error: ${response.status}`);\r\n          }\r\n          return response.json();\r\n        })\r\n        .then(data => {\r\n          console.log(data)\r\n          overallSalesCount.innerHTML = ''\r\n          overallSalesCount.innerHTML = data.overallSalesCount\r\n          overallOrderAmount.innerHTML = ''\r\n          overallOrderAmount.innerHTML = `₹${data.overallOrderAmount.toFixed(2)}`;\r\n          totalCouponDiscount.innerHTML = ''\r\n          totalCouponDiscount.innerHTML = `₹${data.totalCouponDiscount.toFixed(2)}`;\r\n          \r\n          \r\n    \r\n          updateReportTable(data.data);\r\n          updatePagination(data.currentPage, data.totalPages, data.totalRecordsCount);\r\n        })\r\n        .catch(error => console.error('Error fetching sales report:', error));\r\n      }\r\n    \r\n      // Event listener for Filter dropdown\r\n      document.getElementById('filterOption').addEventListener('change', function (event) {\r\n        const selectedFilter = event.target.value;\r\n        \r\n        fetchSalesReport(1, selectedFilter);\r\n      });\r\n    \r\n      // Update the table rows\r\n      function updateReportTable(data) {\r\n        const tBody = document.querySelector('tbody');\r\n        tBody.innerHTML = '';  // Clear previous rows\r\n    \r\n        data.forEach(order => {\r\n          const row = document.createElement('tr');\r\n          row.innerHTML = `\r\n            <td class=\"px-6 py-4 text-sm text-gray-600\">${order.orderId}</td>\r\n            <td class=\"px-6 py-4 text-sm text-gray-600\">${order.userId.substring(0, 4) + '...' + order.userId.slice(-5)}</td>\r\n            <td class=\"px-6 py-4 text-sm text-gray-600\">${new Date(order.createdAt).toLocaleDateString('en-GB')}</td>\r\n            <td class=\"px-6 py-4 text-sm text-gray-600\">₹${order.totalPrice.toFixed(2)}</td>\r\n            <td class=\"px-6 py-4 text-sm text-gray-600\">₹${order.couponDiscount.toFixed(2)}</td>\r\n          <td class=\"px-6 py-4 text-sm text-gray-600\">${order.orderStatus}</td>\r\n\r\n            <td class=\"px-6 py-4 text-sm text-gray-600\">${order.paymentMethod}</td>\r\n         \r\n          `;\r\n          tBody.appendChild(row);\r\n        });\r\n      }\r\n    \r\n      // Update pagination buttons and info\r\n      function updatePagination(current, total, totalRecords) {\r\n        currentPage = current;\r\n        totalPages = total;\r\n    \r\n        document.getElementById('currentPage').innerText = current;\r\n        document.getElementById('totalPages').innerText = total;\r\n        document.getElementById('totalRecords').innerText = totalRecords;\r\n    \r\n        document.getElementById('prevPage').disabled = currentPage === 1;\r\n        document.getElementById('nextPage').disabled = currentPage === totalPages;\r\n      }\r\n    \r\n      document.getElementById('prevPage').addEventListener('click', function () {\r\n        if (currentPage > 1) {\r\n          fetchSalesReport(currentPage - 1);\r\n        }\r\n      });\r\n    \r\n      document.getElementById('nextPage').addEventListener('click', function () {\r\n        console.log(\"Ima next\");\r\n        console.log(\"tottal pages = \",totalPages);\r\n        console.log(\"currentPage page = \",currentPage);\r\n        \r\n        \r\n        \r\n        if (currentPage < totalPages) {\r\n          fetchSalesReport(currentPage + 1);\r\n        }\r\n      });\r\n    \r\n    \r\n      \r\n    //--------------Report generation -------------------\r\n    \r\n    document.getElementById('export').addEventListener('change',function(event){\r\n        const selectedExport = event.target.value;\r\n    \r\n        if(selectedExport){\r\n            const filterOption = document.getElementById('filterOption').value;\r\n    \r\n           exportReport(selectedExport,filterOption)\r\n            \r\n    \r\n        }\r\n    })\r\n    \r\n    \r\n    function exportReport(format,filterOption){\r\n    \r\n    \r\n        const URL = `/admin/exportReport?format=${format}&filter=${filterOption}`\r\n    \r\n        fetch(URL,{\r\n            headers:{\r\n                'Accept':'application/json'\r\n            }\r\n        })\r\n        .then(response=>response.blob())\r\n        .then(blob=>{\r\n    \r\n            const url = window.URL.createObjectURL(blob);\r\n            const a = document.createElement('a');\r\n            a.href = url\r\n    \r\n            //file name\r\n    \r\n            a.download = `sales_report.${format === 'excel' ? 'xlsx' : 'pdf'}`;\r\n    \r\n            document.body.appendChild(a)\r\n            a.click();\r\n            a.remove();\r\n         \r\n    \r\n        })\r\n        .catch(error=>console.error('Error exporting report:', error))\r\n    \r\n    \r\n    }\r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    </script>\r\n<%- include('../layouts/footer.ejs') %>"
        }
    ]
}